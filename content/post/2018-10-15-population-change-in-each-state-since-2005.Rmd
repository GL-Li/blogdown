---
title: Cities boomed and doomed
author: GL Li
date: '2018-10-15'
slug: population-change-in-each-state-since-2005
categories:
  - census
tags:
  - census
description: ''
thumbnail: ''
---

```{r echo=FALSE}
library(knitr)
opts_chunk$set(message = FALSE, warning = FALSE)
```

With the newly added data, the `totalcensus` package now is able to extract data from summary files of decennial census 2000 and 2010, ACS (American Community Survey) 1 year estimates from 2005 to 2017, and ACS 5 year estimates with ending year from 2009 to 2017. With this capacity we can easily look into how things change over the years. 

In this post I will show how to extract population of large cities in 2005 and 2017 and compare the changes in population. We will use ACS 1 year estimates, which cover geographic areas with population over 65000. 
First we load the packages used to extract, wrangle, and plot the data.

```{r}
library(totalcensus)
library(data.table)
library(magrittr)
library(ggplot2)
library(ggmap)
library(leaflet)
# You need to use your own google clound API
# register_google("your_google_api_key")
```

```{r echo=FALSE}
google_api_key <- Sys.getenv("GOOGLE_API_KEY")
register_google(google_api_key)

```

Let's plot the population and change on map. 

```{r fig.width=9}
pop1 <- read_acs5year(year = 2012, 
                     states = c(states_DC, "PR"),
                     summary_level = "place", 
                     with_margin = TRUE,
                     show_progress = FALSE) %>%
    .[, error := population_margin / population] %>%
    .[error < 0.005] %>%
    .[, .(GEOID, NAME, lon, lat, p1 = population)]

pop2 <- read_acs5year(year = 2017, 
                     states = c(states_DC, "PR"),
                     summary_level = "place", 
                     with_margin = TRUE,
                     show_progress = FALSE) %>%
    .[, error := population_margin / population] %>%
    .[error < 0.005] %>%
    .[, .(GEOID, NAME, lon, lat, p2 = population)]


popul_city <- pop1[pop2, on = .(GEOID, NAME, lon, lat)] %>%
    .[lon > -130 & lon < -68] %>%
    .[, change := 100 * (p2 - p1) / p1] %>%
    .[, GEOID := reorder(GEOID, -change)] %>%
    .[p1 > 1000 & p2 > 1000] %>%
    .[!is.na(change), group := "A"] %>%
    .[change > 0, group := "B"] %>%
    .[change > 5, group := "C"] %>%
    .[change > 10, group := "D"] %>%
    .[change > 15, group := "E"] %>%
    .[order(-p2)]

us_map <- get_map("united states", zoom = 4, color = "bw")

ggmap(us_map) +
    geom_point(data = popul_city, 
               aes(lon, lat, size = p2, color = group), alpha = 0.5) +
    labs(color = "population\nchange (%)",
         size = "2017 population\n(million)",
         title = "Largest cities: 2017 population and population change since 2005",
         x = NULL,
         y = NULL) +
    scale_size_area(max_size = 10,
                    breaks = c(0.1, 0.5, 1, 5, 8)) +
    scale_color_manual(values = c("A" = "blue",
                                  "B" = "green",
                                  "C" = "cyan", 
                                  "D" = "orange",
                                  "E" = "magenta")) +
    guides(size = guide_legend(override.aes = list(shape = 1))) +
    coord_map(xlim = c(), ylim = c(25, 50)) +
    theme(#axis.text = element_blank(),
        axis.ticks = element_blank())
```

```{r}
pal <- colorFactor(
    palette = c("blue", "green", "cyan", "orange", "magenta"),
    domain = popul_city$group
)
leaflet(popul_city) %>% addTiles() %>%
    addCircles(lng = ~lon, lat = ~lat, weight = 1,
               radius = ~p2^0.5 * 30, 
               popup = paste0(popul_city$NAME, "<br>", 
                              "2017 population: ", popul_city$p2, "<br>",
                              "5-year population change: ", 
                              round(popul_city$change, 2), "%"), 
               color = ~pal(group), fillOpacity = 0.5) 
```

