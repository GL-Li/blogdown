---
title: Cities boomed and doomed
author: GL Li
date: '2018-10-15'
slug: population-change-in-each-state-since-2005
categories:
  - census
tags:
  - census
description: ''
thumbnail: ''
---

```{r echo=FALSE}
library(knitr)
opts_chunk$set(message = FALSE, warning = FALSE)
```

With the newly added data, the `totalcensus` package now is able to extract data from summary files of decennial census 2000 and 2010, ACS (American Community Survey) 1 year estimates from 2005 to 2017, and ACS 5 year estimates with ending year from 2009 to 2017. With this capacity we can easily look into how things change over the years. 

In this post I will show how to extract population of all cities in 2012 and 2017 and compare the changes in population. We will use ACS 5 year estimates.

```{r}
library(totalcensus)
library(data.table)
library(magrittr)
library(ggplot2)
library(leaflet)

# read data and keep only population error less than 0.5%
pop1 <- read_acs5year(year = 2012, 
                     states = c(states_DC, "PR"),
                     summary_level = "place", 
                     with_margin = TRUE,
                     show_progress = FALSE) %>%
    .[, error := population_margin / population] %>%
    .[error < 0.005] %>%
    .[, .(GEOID, NAME, lon, lat, p1 = population)]

pop2 <- read_acs5year(year = 2017, 
                     states = c(states_DC, "PR"),
                     summary_level = "place", 
                     with_margin = TRUE,
                     show_progress = FALSE) %>%
    .[, error := population_margin / population] %>%
    .[error < 0.005] %>%
    .[, .(GEOID, NAME, lon, lat, p2 = population)]

# split population change into 5 groups: 
# A - decrease, B - increase less than 5%, C - less than 10%
# C - less than 15%, D- more than 15%
popul_city <- pop1[pop2, on = .(GEOID, NAME, lon, lat)] %>%
    .[lon > -130 & lon < -68] %>%
    .[, change := 100 * (p2 - p1) / p1] %>%
    .[, GEOID := reorder(GEOID, -change)] %>%
    .[p1 > 1000 & p2 > 1000] %>%
    .[!is.na(change), group := "A"] %>%
    .[change > 0, group := "B"] %>%
    .[change > 5, group := "C"] %>%
    .[change > 10, group := "D"] %>%
    .[change > 15, group := "E"] %>%
    .[order(-p2)]

# interactive mapping with leaflet
pal <- colorFactor(
    palette = c("blue", "green", "cyan", "orange", "magenta"),
    domain = popul_city$group
)
leaflet(popul_city) %>% addTiles() %>%
    addCircles(lng = ~lon, lat = ~lat, weight = 1,
               radius = ~p2^0.5 * 30, 
               popup = paste0(popul_city$NAME, "<br>", 
                              "2017 population: ", popul_city$p2, "<br>",
                              "5-year population change: ", 
                              round(popul_city$change, 2), "%"), 
               color = ~pal(group), fillOpacity = 0.5) 
```

